var words_jesus = {
       "god": {
           "polarity": 1,
           "count": 195
       },
       "man": {
           "polarity": 1,
           "count": 155
       },
       "israel": {
           "polarity": 1,
           "count": 145
       },
       "son": {
           "polarity": 1,
           "count": 120
       },
       "jesus": {
           "polarity": 1,
           "count": 120
       },
       "lord": {
           "polarity": 1,
           "count": 195
       },
       "faith": {
           "polarity": 1,
           "count": 150
       },
       "spirit": {
           "polarity": 1,
           "count": 134
       },
       "love": {
           "polarity": 1,
           "count": 120
       },
       "sin": {
           "polarity": -1,
           "count": 130
       },
       "grace": {
           "polarity": 1,
           "count": 125
       },
       "light": {
           "polarity": 1,
           "count": 100
       },
       "doubt": {
           "polarity": 1,
           "count": 75
       },
       "people": {
           "polarity": 1,
           "count": 130
       },
       "house": {
           "polarity": 1,
           "count": 80
       },
       "father": {
           "polarity": 1,
           "count": 70
       },
       "evil": {
           "polarity": -1,
           "count": 72
       },
       "heaven": {
           "polarity": 1,
           "count": 66
       },
       "fire": {
           "polarity": 1,
           "count": 63
       },
       "egypt": {
           "polarity": 2,
           "count": 60
       },
       "life": {
           "polarity": 1,
           "count": 57
       },
       "fear": {
           "polarity": -1,
           "count": 57
       },
       "christ": {
           "polarity": 1,
           "count": 54
       },
       "servants": {
           "polarity": 1,
           "count": 47
       },
       "glory": {
           "polarity": 1,
           "count": 45
       },
       "peace": {
           "polarity": 1,
           "count": 43
       },
       "death": {
           "polarity": -1,
           "count": 45
       },
       "sword": {
           "polarity": -1,
           "count": 46
       },
       "water": {
           "polarity": 1,
           "count": 40
       },
       "sea": {
           "polarity": 1,
           "count": 41
       },
       "work": {
           "polarity": -1,
           "count": 37
       },
       "blood": {
           "polarity": -1,
           "count": 33
       },
       "wife": {
           "polarity": 1,
           "count": 30
       },
       "brother": {
           "polarity": 1,
           "count": 27
       },
       "end": {
           "polarity": -1,
           "count": 19
       },
       "kingdom": {
           "polarity": 1,
           "count": 17
       },
       "altar": {
           "polarity": 1,
           "count": 15
       },
       "enemies": {
           "polarity": -3,
           "count": 19
       },
       "bread": {
           "polarity": 1,
           "count": 10
       },
       "wisdom": {
           "polarity": 1,
           "count": 7
       },
       "judgement": {
           "polarity": -1,
           "count": 17
       },
       "love": {
           "polarity": 1,
           "count": 6
       },
       "peace": {
           "polarity": 1,
           "count": 62
       },
       "love": {
           "polarity": 1,
           "count": 6
       },
       "commanded": {
           "polarity": -1,
           "count": 19
       },
       "earth": {
           "polarity": 1,
           "count": 23
       },
       "house": {
           "polarity": 1,
           "count": 54
       },
       "children": {
           "polarity": 1,
           "count": 45
       },
       "himself": {
           "polarity": 2,
           "count": 19
       },
       "face": {
           "polarity": 1,
           "count": 12
       },
       "flesh": {
           "polarity": -1,
           "count": 12
       },
       "old": {
           "polarity": -1,
           "count": 6
       },
       "priests": {
           "polarity": 2,
           "count": 23
       },
       "mouth": {
           "polarity": 1,
           "count": 4
       },
       "temple": {
           "polarity": 1,
           "count": 7
       },
       "daughter": {
           "polarity": 1,
           "count": 8
       },
       "nations": {
           "polarity": 1,
           "count": 22
       },
       "chief": {
           "polarity": 1,
           "count": 11
       },
       "soul": {
           "polarity": 1,
           "count": 7
       },
       "right": {
           "polarity": 1,
           "count": 6
       },
       "heart": {
           "polarity": 1,
           "count": 13
       },
       "hand": {
           "polarity": 1,
           "count": 23
       },
       "heart": {
           "polarity": 1,
           "count": 13
       },
       "day": {
           "polarity": 1,
           "count": 160
       },
       "heart": {
           "polarity": 1,
           "count": 13
       },
       "jerusalem": {
           "polarity": 1,
           "count": 89
       },
       "david": {
           "polarity": 1,
           "count": 87
       },
       "moses": {
           "polarity": 1,
           "count": 84
       },
       "congregation": {
           "polarity": 2,
           "count": 13
       },
       "world": {
           "polarity": 1,
           "count": 11
       },
       "saul": {
           "polarity": -2,
           "count": 8
       },
       "aaron": {
           "polarity": 1,
           "count": 7
       },
       "tabernacle": {
           "polarity": 1,
           "count": 5
       },
       "sheep": {
           "polarity": 1,
           "count": 7
       },
       "abandon": {
           "polarity": -1,
           "count": 21
       },
       "abusing": {
           "polarity": -1,
           "count": 22
       },
       "praise the lord": {
           "polarity": 1,
           "count": 11
       },
       "give thanks": {
           "polarity": 2,
           "count": 3
       },
       "rejoice": {
           "polarity": 1,
           "count": 5
       },
       "high places": {
           "polarity": 1,
           "count": 14
       },
       "holy ghost": {
           "polarity": -11,
           "count": 21
       },
       "Do not fear": {
           "polarity": 1,
           "count": 22
       },
       "don't be afraid": {
           "polarity": 1,
           "count": 22
       },
       "end of the earth": {
           "polarity": -1,
           "count": 25
       },
       "kiss of life": {
           "polarity": 1,
           "count": 14
       },
       "amen": {
           "polarity": 1,
           "count": 67
       },
       "satan": {
           "polarity": -1,
           "count": 7
       },
       "devil": {
           "polarity": -1,
           "count": 8
       }

};

var shuffling = true; // shuffling make less-sparsed word clouds
var spiral = "archimedean"; // 'archimedean or 'rectangular'
var outter = true; // (try to) make disappearing words outter

var person = "jesus";
var zoom_group; // reusable d3 selection

var words = {};

Object.keys(words_jesus).forEach(function (word_lemma) {
    if (words[word_lemma]) {
        words[word_lemma].jesus = words_jesus[word_lemma];
    } else {
        w = words[word_lemma] = {
            "lana": {
                "polarity": words_jesus[word_lemma].polarity,
                "count": 0
            },
            "jesus": words_jesus[word_lemma]
        }
    }
});

Math.seedrandom('abcde'); // define a fixed random seed, to avoid to have a different layout on each page reload. change the string to randomize

var words_frequency = [];
var max = -Infinity;
Object.keys(words).forEach(function (word_lemma) {
    o = words[word_lemma];
    o.lemma = word_lemma;
    o.maxCount = Math.max(o.lana.count, o.jesus.count);

    words_frequency.push(o);
    if (max < o.maxCount) {
        max = o.maxCount;
    }
});
console.log("max: " + max);


var font_size = d3.scale.linear()
    .domain([1, max])
    .range([10, 100]);


// var color = d3.scale.linear()
//     .domain([-max, 0, max])
//     .range([d3.hcl(36, 65, 50), d3.hcl(95, 65, 80), d3.hcl(150, 65, 50)])
//     .interpolate(d3.interpolateHcl);

var color = d3.scale.quantize()
    .domain([-max, max])
    .range([d3.hcl(36, 65, 50), d3.hcl(150, 65, 50)]);

if (shuffling) {
    shuffle(words_frequency);
}
words_frequency.sort(function (a, b) {
    if (outter) {
        return (b.maxCount - a.maxCount) +
            (((b.lana.count === 0) || (b.jesus.count === 0)) ? 1 : 0);
    } else {
        return (b.maxCount - a.maxCount);
    }
});

d3.layout.cloud().size([960, 500])
    .words(words_frequency)
    .rotate(function () {
        return ~~(Math.random() * 2) * 90;
    })
    .font("Impact")
    .spiral(spiral)
    .text(function (d) {
        return d.lemma;
    })
    .fontSize(function (d) {
        return font_size(d.maxCount);
    })
    .on("end", draw)
    .start();

function draw(words) {
    var svg = d3.select("body").append("svg")
        .classed('jesus', true)
        .attr("width", 960)
        .attr("height", 500);


    // append a group for zoomable content
    zoom_group = svg.append('g');

    // define a zoom behavior
    // var zoom = d3.behavior.zoom()
    //     .scaleExtent([1, 4]) // min-max zoom
    //     .on('zoom', function () {
    //         // whenever the user zooms,
    //         // modify translation and scale of the zoom group accordingly
    //         zoom_group.attr('transform', 'translate(' + zoom.translate() + ')scale(' + zoom.scale() + ')');
    //     });

    // bind the zoom behavior to the main SVG
    // svg.call(zoom);


    zoom_group.append("g")
        .attr("transform", "translate(480,250)")
        .selectAll("text")
        .data(words)
        .enter()
        .append("text")
        .style("font-size", function (d) {
            return font_size(d[person].count) + "px";
        })
        .style("font-family", "Impact")
        .style("fill", function (d) {
            return color(d[person].polarity);
        })
        .style("fill-opaperson", function (d) {
            return (d[person].count > 0) ? 1 : 0;
        })
        .attr("text-anchor", "middle")
        .attr("transform", function (d) {
            var far = 1500 * (Math.random() > 0.5 ? +1 : -1);
            if (d.rotate === 0)
                return "translate(" + far + ",0)rotate(" + d.rotate + ")";
            else
                return "translate(0," + far + ")rotate(" + d.rotate + ")";
        })
        .text(function (d) {
            return d.lemma;
        })
        .transition()
        .duration(2000)
        .attr("transform", function (d) {
            return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
        });
}


function shuffle(array) {
    let counter = array.length;

    // While there are elements in the array
    while (counter > 0) {
        // Pick a random index
        let index = Math.floor(Math.random() * counter);

        // Decrease counter by 1
        counter--;

        // And swap the last element with it
        let temp = array[counter];
        array[counter] = array[index];
        array[index] = temp;
    }

    return array;
}